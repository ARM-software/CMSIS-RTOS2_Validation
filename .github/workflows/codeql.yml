name: "CodeQL"

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      # Required for all workflows
      security-events: write

      # Only required for workflows in private repositories
      actions: read
      contents: read
    env:
      CMSIS_PACK_ROOT: /tmp/.packs-${{ github.run_id }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    #- name: Install build dependencies
    #  run: |
    #    sudo apt install gcc-arm-none-eabi ninja-build cmake

    - name: Cache pack folder
      id: cache-packs
      uses: actions/cache@v3
      with:
        key: packs-${{ github.run_id }}
        restore-keys: |
          packs-
        path: /tmp/.packs-${{ github.run_id }}

    - name: Initialize packs folder
      if: steps.cache-packs.outputs.cache-hit != 'true'
      run: cpackget init https://www.keil.com/pack/index.pidx

    - name: Update pack index
      if: steps.cache-packs.outputs.cache-hit == 'true'
      run: cpackget update-index
    
    - name: Download and install CMSIS packs
      run: cpackget add -a -f cpacklist.txt || exit 1

    - name: Install build.py requirements
      run: pip install -r requirements.txt
      working-directory: Project

    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: cpp
        queries: security-and-quality

    - name: Build projects
      working-directory: Project
      run: |
        # echo "Install Python requirements"
        # pip install -r requirements.txt

        echo "Activate vcpkg environment"
        . <(curl https://aka.ms/vcpkg-init.sh -L)
        vcpkg activate

        # Download and install CMSIS packs
        #cpackget add -a -f cpacklist.txt || exit 1

        # Build test projects
        python build.py --verbose build || echo "Something failed!"

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
