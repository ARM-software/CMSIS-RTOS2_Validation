name: "CodeQL"

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
# Cancel in-progress job or run for the current workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      # Required for all workflows
      security-events: write

      # Only required for workflows in private repositories
      actions: read
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - working-directory: /home/runner
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        if [ -d CMSIS_6 ]; then
          cd CMSIS_6
          git fetch origin main
          git checkout -f origin/main
        else
          gh repo clone ARM-software/CMSIS_6
        fi

    - working-directory: /home/runner
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        if [ -d CMSIS-RTX ]; then
          cd CMSIS-RTX
          git fetch origin main
          git checkout -f origin/main
        else
          gh repo clone ARM-software/CMSIS-RTX
        fi

    - working-directory: /home/runner
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        if [ -d CMSIS-FreeRTOS ]; then
          cd CMSIS-FreeRTOS
          git fetch origin main
          git checkout -f origin/main
        else
          gh repo clone ARM-software/CMSIS-FreeRTOS
        fi

    - uses: actions/setup-python@v4
      with:
        python-version: '3.10'    
        cache: 'pip'

    - name: Cache vcpkg
      uses: actions/cache@v3
      with:
        key: vcpkg
        path: /home/runner/.vcpkg
      
    - name: Cache Arm Compiler 6
      uses: actions/cache@v3
      with:
        key: armcompiler-6.20.0
        path: /home/runner/standalone-linux-x86_64-rel.tgz

    - name: Install Arm Compiler 6.20.0
      working-directory: /home/runner
      run: |
        test -f standalone-linux-x86_64-rel.tgz || \
          wget https://artifacts.keil.arm.com/arm-compiler/6.20/21/standalone-linux-x86_64-rel.tgz
        mkdir -p arm-compiler-6.20.0
        tar xf standalone-linux-x86_64-rel.tgz -C arm-compiler-6.20.0
        echo "AC6_TOOLCHAIN_6_20_0=$(pwd)/arm-compiler-6.20.0/bin" >> $GITHUB_ENV

    - name: Cache LLVM/Clang
      uses: actions/cache@v3
      with:
        key: clang-16.0.0
        path: /home/runner/LLVMEmbeddedToolchainForArm-16.0.0-Linux-x86_64.tar.gz

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: cpp
        queries: security-and-quality

    - uses: ammaraskar/gcc-problem-matcher@master

    - name: Setup environment and build projects
      working-directory: Project
      run: |
        echo "Install Python requirements"
        pip install -r requirements.txt

        echo "Activate vcpkg environment"
        . <(curl https://aka.ms/vcpkg-init.sh -L)
        vcpkg activate --project vcpkg-cfg-codeql.json

        echo "Activate Arm tool license"
        ${AC6_TOOLCHAIN_6_20_0}/armlm activate --server https://mdk-preview.keil.arm.com --product KEMDK-COM0

        echo "Check tool environment"
        echo "AC6       : $(which $AC6_TOOLCHAIN_6_20_0/armclang)"
        echo "GCC       : $(which arm-none-eabi-gcc)"
        echo "cbuild    : $(which cbuild)"
        echo "cpackget  : $(which cpackget)"
        echo "csolution : $(which csolution)"

        echo "Register local packs"
        cpackget add /home/runner/CMSIS_6/ARM.CMSIS.pdsc
        cpackget add /home/runner/CMSIS-RTX/ARM.CMSIS-RTX.pdsc
        cpackget add /home/runner/CMSIS-FreeRTOS/ARM.CMSIS-FreeRTOS.pdsc

        echo "Download and install CMSIS packs"
        cpackget update-index
        cpackget add Keil::V2M-MPS2_CMx_BSP@1.8.0
        cpackget add Keil::V2M-MPS2_IOTKit_BSP@1.5.0
        cpackget add ARM::V2M_MPS3_SSE_300_BSP@1.3.0

        echo "Run build script to build test projects"
        python build.py --verbose build || echo "Something failed!"
        
        echo "Deactivate Arm tool license"
        ${AC6_TOOLCHAIN_6_20_0}/armlm deactivate --product KEMDK-COM0

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
