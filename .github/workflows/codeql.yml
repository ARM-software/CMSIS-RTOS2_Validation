name: "CodeQL"

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
# Cancel in-progress job or run for the current workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      # Required for all workflows
      security-events: write

      # Only required for workflows in private repositories
      actions: read
      contents: read

    steps:
    - name: Cache Arm Compiler 6
      uses: actions/cache@v3
      with:
        key: armcompiler-6.20.0
        path: /home/runner/standalone-linux-x86_64-rel.tgz

    - name: Install Arm Compiler 6.20.0
      working-directory: /home/runner
      run: |
        test -f standalone-linux-x86_64-rel.tgz || \
          wget https://artifacts.keil.arm.com/arm-compiler/6.20/21/standalone-linux-x86_64-rel.tgz
        mkdir -p arm-compiler-6.20.0
        tar xf standalone-linux-x86_64-rel.tgz -C arm-compiler-6.20.0
        echo "AC6_TOOLCHAIN_6_20_0=$(pwd)/arm-compiler-6.20.0/bin" >> $GITHUB_ENV

    - name: Checkout repository
      uses: actions/checkout@v3

    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: cpp
        queries: security-and-quality

    - uses: ammaraskar/gcc-problem-matcher@master

    - name: Setup environment and build projects
      working-directory: Project
      run: |
        echo "Install Python requirements"
        pip install -r requirements.txt

        echo "Activate vcpkg environment"
        . <(curl https://aka.ms/vcpkg-init.sh -L)
        vcpkg activate --project vcpkg-cfg-codeql.json

        echo "Activate Arm tool license"
        ${AC6_TOOLCHAIN_6_20_0}/armlm activate --server https://mdk-preview.keil.arm.com --product KEMDK-COM0

        echo "Check tool environment"
        echo "AC6       : $(which $AC6_TOOLCHAIN_6_20_0/armclang)"
        echo "GCC       : $(which arm-none-eabi-gcc)"
        echo "cbuild    : $(which cbuild)"
        echo "cpackget  : $(which cpackget)"
        echo "csolution : $(which csolution)"

        echo "Download and install CMSIS packs"
        cpackget add -a -f cpacklist.txt || exit 1

        echo "Run build script to build test projects"
        python build.py --verbose build || echo "Something failed!"
        
        echo "Deactivate Arm tool license"
        ${AC6_TOOLCHAIN_6_20_0}/armlm deactivate --product KEMDK-COM0

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
